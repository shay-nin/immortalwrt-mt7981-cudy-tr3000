name: Build ImmortalWrt / OpenWrt for Cudy TR3000

on:
  workflow_dispatch:
    inputs:
      clean:
        description: '是否 clean build (清理 + 全新编译)'
        required: false
        default: 'false'

env:
  CCACHE_DIR: /workdir/.ccache
  CCACHE_MAXSIZE: 6G
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6.git
  REPO_BRANCH: openwrt-24.10-6.6
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout fork (scripts + config)
        uses: actions/checkout@v4

      - name: Setup build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -qq -y \
            build-essential subversion libncurses5-dev libncursesw5-dev \
            gawk git gettext libssl-dev xsltproc zlib1g-dev unzip file \
            libelf-dev autoconf automake patch flex bison python3 python3-pip \
            squashfs-tools

      - name: Clone ImmortalWrt source
        run: |
          git clone -b $REPO_BRANCH $REPO_URL openwrt

      - name: Custom part 1 — feeds & config fragment
        run: |
          chmod +x ${{ env.DIY_P1_SH }}
          bash ${{ env.DIY_P1_SH }}

      - name: Custom part 2 — diy-part2.sh
        run: |
          if [ -f "${{ env.DIY_P2_SH }}" ]; then
            chmod +x ${{ env.DIY_P2_SH }}
            bash ${{ env.DIY_P2_SH }}
          fi

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc)

      - name: Upload firmware artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.run_id }}
          path: openwrt/bin/targets/*/*

      - name: (Optional) Create GitHub release
        if: success() && env.UPLOAD_RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "release-${{ github.run_id }}"
          files: openwrt/bin/targets/*/*sysupgrade.bin
